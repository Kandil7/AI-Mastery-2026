name: CI Pipeline

on:
    push:
        branches: [main, develop, feature/*]
    pull_request:
        branches: [main, develop]

env:
    PYTHON_VERSION: "3.10"

jobs:
    lint:
        name: Lint & Format Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8 black isort mypy
                  pip install -r requirements.txt

            - name: Check formatting with Black
              run: black --check --diff src/ tests/ scripts/

            - name: Check imports with isort
              run: isort --check-only --diff src/ tests/ scripts/

            - name: Lint with flake8
              run: flake8 src/ tests/ scripts/ --max-line-length=120 --ignore=E501,W503

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest pytest-cov pytest-asyncio

            - name: Run tests with coverage
              run: |
                  pytest tests/ -v --cov=src --cov-report=xml --cov-report=html

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  fail_ci_if_error: false

    build-docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: |
                  docker build -t ai-mastery-2026:${{ github.sha }} .
                  docker build -t ai-mastery-2026:latest .

            - name: Test Docker image
              run: |
                  docker run --rm ai-mastery-2026:latest python -c "import src; print('Import successful')"

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install security scanners
              run: |
                  pip install safety bandit

            - name: Run safety check
              run: safety check -r requirements.txt || true

            - name: Run bandit security scan
              run: bandit -r src/ -ll || true

    model-validation:
        name: Validate Models
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  pip install -r requirements.txt

            - name: Train and save models
              run: python scripts/train_save_models.py

            - name: Validate model files exist
              run: |
                  test -f models/classification_model.joblib
                  test -f models/regression_model.joblib
                  test -f models/logistic_model.joblib
                  test -f models/models_metadata.json

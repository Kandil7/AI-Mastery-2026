# =============================================================================
# RAG Engine Mini - Makefile
# =============================================================================
# Development commands for the RAG project
# Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ·ÙˆÙŠØ± Ù„Ù…Ø´Ø±ÙˆØ¹ RAG
# =============================================================================

.PHONY: help install run worker test format lint typecheck migrate seed docker-up docker-down clean

# Default target
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘              RAG Engine Mini - Development Commands              â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  install      Install dependencies                               â•‘"
	@echo "â•‘  run          Run FastAPI server (dev mode)                      â•‘"
	@echo "â•‘  run-prod     Run FastAPI server (production mode)               â•‘"
	@echo "â•‘  worker       Run Celery worker                                  â•‘"
	@echo "â•‘  test         Run all tests                                      â•‘"
	@echo "â•‘  demo         Start Gradio frontend demo                         â•‘"
	@echo "â•‘  eval         Run retrieval evaluation script                     â•‘"
	@echo "â•‘  format       Format code with black + isort                     â•‘"
	@echo "â•‘  lint         Lint code with ruff                                â•‘"
	@echo "â•‘  migrate      Run database migrations                            â•‘"
	@echo "â•‘  seed         Seed demo user                                     â•‘"
	@echo "â•‘  docker-up    Start all services with Docker                     â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# =============================================================================
# Installation / Ø§Ù„ØªØ«Ø¨ÙŠØª
# =============================================================================

install:
	@echo "ðŸ“¦ Installing dependencies..."
	pip install -e ".[dev]"
	@echo "âœ… Dependencies installed successfully"

install-local:
	@echo "ðŸ“¦ Installing with local LLM support..."
	pip install -e ".[dev,local]"
	@echo "âœ… Dependencies installed successfully"

# =============================================================================
# Running / Ø§Ù„ØªØ´ØºÙŠÙ„
# =============================================================================

run:
	@echo "ðŸš€ Starting FastAPI server (dev mode)..."
	uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

run-prod:
	@echo "ðŸš€ Starting FastAPI server (production mode)..."
	uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4

worker:
	@echo "âš™ï¸ Starting Celery worker..."
	celery -A src.workers.celery_app.celery_app worker -Q indexing --loglevel=INFO

worker-beat:
	@echo "â° Starting Celery beat (scheduler)..."
	celery -A src.workers.celery_app.celery_app beat --loglevel=INFO

flower:
	@echo "ðŸŒ¸ Starting Flower (Celery monitoring)..."
	celery -A src.workers.celery_app.celery_app flower --port=5555

# =============================================================================
# Testing / Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
# =============================================================================

test:
	@echo "ðŸ§ª Running tests..."
	pytest tests/ -v

test-cov:
	@echo "ðŸ§ª Running tests with coverage..."
	pytest tests/ -v --cov=src --cov-report=html --cov-report=term-missing
	@echo "ðŸ“Š Coverage report generated in htmlcov/"

test-unit:
	@echo "ðŸ§ª Running unit tests..."
	pytest tests/unit/ -v

test-integration:
	@echo "ðŸ§ª Running integration tests..."
	pytest tests/integration/ -v

# =============================================================================
# Code Quality / Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
# =============================================================================

format:
	@echo "ðŸŽ¨ Formatting code..."
	black src/ tests/
	isort src/ tests/
	@echo "âœ… Code formatted"

format-check:
	@echo "ðŸ” Checking code format..."
	black --check src/ tests/
	isort --check-only src/ tests/

lint:
	@echo "ðŸ” Linting code..."
	ruff check src/ tests/
	@echo "âœ… Linting complete"

lint-fix:
	@echo "ðŸ”§ Fixing lint issues..."
	ruff check --fix src/ tests/
	@echo "âœ… Lint issues fixed"

typecheck:
	@echo "ðŸ“ Type checking..."
	mypy src/
	@echo "âœ… Type check complete"

check-all: format-check lint typecheck
	@echo "âœ… All checks passed"

# =============================================================================
# Database / Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# =============================================================================

migrate:
	@echo "ðŸ“Š Running database migrations..."
	alembic upgrade head
	@echo "âœ… Migrations complete"

migrate-rev:
	@echo "ðŸ“ Creating new migration revision..."
	@read -p "Migration message: " msg; \
	alembic revision --autogenerate -m "$$msg"

migrate-down:
	@echo "â¬‡ï¸ Rolling back last migration..."
	alembic downgrade -1

migrate-history:
	@echo "ðŸ“œ Migration history..."
	alembic history

seed:
	@echo "ðŸŒ± Seeding demo user..."
	python scripts/seed_user.py
	@echo "âœ… Demo user created"

eval-ragas:
	@echo "ðŸ§ª Running RAGAS evaluation..."
	python scripts/evaluate_ragas.py

generate-testset:
	@echo "ðŸ”„ Generating synthetic testset..."
	python scripts/generate_synthetic_testset.py --input data/samples/sample_doc.txt

# =============================================================================
# Docker / Ø¯ÙˆÙƒØ±
# =============================================================================

docker-down:
	@echo "ðŸ³ Stopping Docker services..."
	docker compose -f docker/docker-compose.yml down
	@echo "âœ… Services stopped"

## ðŸš€ Production Deployment
prod-check:
	@echo "ðŸ” Running production readiness audit (Inside Container)..."
	docker compose -f docker/docker-compose.prod.yml run --rm api python scripts/check_prod_readiness.py

prod-up:
	@echo "ðŸš€ Deploying Production Stack..."
	docker compose -f docker/docker-compose.prod.yml up -d
	@echo "âœ… Production stack is rising"

prod-down:
	@echo "ðŸ›‘ Stopping Production Stack..."
	docker compose -f docker/docker-compose.prod.yml down
	@echo "âœ… Production stack stopped"

docker-logs:
	@echo "ðŸ“œ Docker logs..."
	docker compose -f docker/docker-compose.yml logs -f

docker-build:
	@echo "ðŸ—ï¸ Building Docker image..."
	docker build -f docker/Dockerfile -t rag-engine-mini .
	@echo "âœ… Image built"

docker-clean:
	@echo "ðŸ§¹ Cleaning Docker resources..."
	docker compose -f docker/docker-compose.yml down -v --remove-orphans
	@echo "âœ… Docker resources cleaned"

# =============================================================================
# Development / Ø§Ù„ØªØ·ÙˆÙŠØ±
# =============================================================================

demo:
	@echo "ðŸŽ¨ Starting Gradio frontend demo..."
	python scripts/frontend_demo.py

eval:
	@echo "ðŸ“Š Running retrieval evaluation..."
	python scripts/eval_retrieval.py

dev-setup: docker-up migrate seed
	@echo "ðŸŽ‰ Development environment ready!"
	@echo "   Run 'make run' in one terminal"
	@echo "   Run 'make worker' in another terminal"
	@echo "   Run 'make demo' in a third terminal"

shell:
	@echo "ðŸ Starting Python shell..."
	python -i -c "from src.core.bootstrap import get_container; c = get_container(); print('Container loaded:', list(c.keys()))"

# =============================================================================
# Cleanup / Ø§Ù„ØªÙ†Ø¸ÙŠÙ
# =============================================================================

clean:
	@echo "ðŸ§¹ Cleaning cache files..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	@echo "âœ… Cache cleaned"

clean-all: clean docker-clean
	@echo "ðŸ§¹ Cleaning uploads..."
	rm -rf uploads/* 2>/dev/null || true
	@echo "âœ… All cleaned"

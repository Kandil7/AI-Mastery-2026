# ğŸ—ï¸ Architecture Overview

> **RAG Engine Mini** - Production-Ready Architecture Guide

---

## ğŸ“ Clean Architecture Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          External World                                  â”‚
â”‚                  (HTTP Requests, Celery Messages)                       â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         API Layer                                  â”‚  â”‚
â”‚  â”‚                     (FastAPI Routes)                               â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â€¢ Thin controllers - no business logic                           â”‚  â”‚
â”‚  â”‚  â€¢ Request validation (Pydantic)                                  â”‚  â”‚
â”‚  â”‚  â€¢ Response formatting                                             â”‚  â”‚
â”‚  â”‚  â€¢ Authentication & tenant extraction                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Application Layer                              â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Use Cases     â”‚ â”‚     Ports       â”‚ â”‚     Services        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (Orchestrators) â”‚ â”‚  (Interfaces)   â”‚ â”‚   (Pure Logic)      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚ â”‚                 â”‚ â”‚                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Upload Doc    â”‚ â”‚ â€¢ LLMPort       â”‚ â”‚ â€¢ Chunking          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Ask Hybrid    â”‚ â”‚ â€¢ VectorStore   â”‚ â”‚ â€¢ RRF Fusion        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Index Doc     â”‚ â”‚ â€¢ KeywordStore  â”‚ â”‚ â€¢ Prompt Builder    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚ â”‚ â€¢ Reranker      â”‚ â”‚ â€¢ Embedding Cache   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                 â”‚ â”‚ â€¢ ...           â”‚ â”‚ â€¢ Text Hydration    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       Domain Layer                                 â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â€¢ Entities: TenantId, DocumentId, Chunk, Answer                  â”‚  â”‚
â”‚  â”‚  â€¢ Value Objects: ChunkSpec, StoredFile                           â”‚  â”‚
â”‚  â”‚  â€¢ Domain Errors: DocumentNotFound, TextExtractionError           â”‚  â”‚
â”‚  â”‚  â€¢ NO external dependencies                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      Adapters Layer                                â”‚  â”‚
â”‚  â”‚                (Implementations of Ports)                         â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ OpenAI   â”‚ â”‚  Qdrant  â”‚ â”‚  Postgres  â”‚ â”‚     Celery       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ LLM/Emb  â”‚ â”‚  Vector  â”‚ â”‚   Repos    â”‚ â”‚     Queue        â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  Redis   â”‚ â”‚ Cross-   â”‚ â”‚   Local    â”‚ â”‚   PDF/DOCX       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Cache   â”‚ â”‚ Encoder  â”‚ â”‚  FileStore â”‚ â”‚   Extractor      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ Ports & Adapters (Dependency Inversion)

### The Pattern / Ø§Ù„Ù†Ù…Ø·

```python
# Port (Interface) - in application/ports/
class LLMPort(Protocol):
    def generate(self, prompt: str, ...) -> str: ...

# Adapter (Implementation) - in adapters/llm/
class OpenAILLM:  # Implements LLMPort
    def generate(self, prompt: str, ...) -> str:
        return self._client.chat.completions.create(...)

# Use Case uses Port, not Adapter
class AskQuestionUseCase:
    def __init__(self, llm: LLMPort):  # Injects via Port
        self._llm = llm

# Bootstrap wires Adapter to Port
container = {
    "llm": OpenAILLM(api_key=settings.openai_api_key),
}
```

### All 14 Ports / Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù€ 14

| Port | Responsibility | Adapter |
|------|----------------|---------|
| `LLMPort` | Text generation | OpenAI, Ollama |
| `EmbeddingsPort` | Text â†’ vector | OpenAI, SentenceTransformers |
| `VectorStorePort` | Vector search | Qdrant |
| `KeywordStorePort` | Full-text search | Postgres FTS |
| `DocumentRepoPort` | Document CRUD | Postgres |
| `DocumentIdempotencyPort` | File hash lookup | Postgres |
| `DocumentReaderPort` | Get stored file | Postgres |
| `ChunkRepoPort` | Chunk dedup | Postgres |
| `ChunkTextReaderPort` | Text hydration | Postgres |
| `ChatRepoPort` | Chat history | Postgres |
| `CachePort` | JSON caching | Redis |
| `FileStorePort` | File storage | Local, S3 |
| `TaskQueuePort` | Background jobs | Celery |
| `RerankerPort` | Result reranking | Cross-Encoder |

---

## ğŸ“Š Data Flow Diagrams

### Upload Flow / ØªØ¯ÙÙ‚ Ø§Ù„Ø±ÙØ¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚â”€â”€â”€â”€â–¶â”‚  POST /upload     â”‚â”€â”€â”€â”€â–¶â”‚   Upload    â”‚
â”‚          â”‚     â”‚                   â”‚     â”‚   UseCase   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                      â–¼                   â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚    â”‚  1. Calculate SHA256 hash                        â”‚  â”‚
           â”‚    â”‚  2. Check idempotency (existing doc?)            â”‚  â”‚
           â”‚    â”‚  3. Store file to FileStore                      â”‚  â”‚
           â”‚    â”‚  4. Create document record with hash             â”‚  â”‚
           â”‚    â”‚  5. Enqueue indexing task                        â”‚  â”‚
           â”‚    â”‚  6. Return {document_id, status: "queued"}       â”‚  â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                                                          â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
           â”‚    â”‚  Celery Worker: index_document                   â”‚  â”‚
           â”‚    â”‚                                                   â”‚  â”‚
           â”‚    â”‚  1. Load document metadata                        â”‚  â”‚
           â”‚    â”‚  2. Extract text (PDF/DOCX/TXT)                   â”‚  â”‚
           â”‚    â”‚  3. Chunk text (token-aware)                      â”‚  â”‚
           â”‚    â”‚  4. Hash chunks for dedup                         â”‚  â”‚
           â”‚    â”‚  5. Batch embed unique chunks                     â”‚  â”‚
           â”‚    â”‚  6. Upsert to chunk_store (Postgres)              â”‚  â”‚
           â”‚    â”‚  7. Upsert to vector store (Qdrant)               â”‚  â”‚
           â”‚    â”‚  8. Update document status: "indexed"             â”‚  â”‚
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ask Hybrid Flow / ØªØ¯ÙÙ‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‡Ø¬ÙŠÙ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚â”€â”€â”€â”€â–¶â”‚  POST /ask-hybrid â”‚â”€â”€â”€â”€â–¶â”‚  AskHybrid  â”‚
â”‚          â”‚     â”‚                   â”‚     â”‚   UseCase   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                                  â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
     â”‚  â”‚ 1. Embed Query  â”‚â—€â”€â”€â”€â”€â”€â”€â”€ CachedEmbeddings                   â”‚
     â”‚  â”‚    (cached)     â”‚                                            â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
     â”‚           â”‚                                                      â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
     â”‚  â”‚ 2. Vector Searchâ”‚  â”‚ 3. Keyword Search â”‚                     â”‚
     â”‚  â”‚    (Qdrant)     â”‚  â”‚   (Postgres FTS)  â”‚                     â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
     â”‚           â”‚                     â”‚                                â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                                â”‚
     â”‚  â”‚ 4. Hydrate Text â”‚           â”‚ (already has text)             â”‚
     â”‚  â”‚   (from DB)     â”‚           â”‚                                â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                                â”‚
     â”‚           â”‚                     â”‚                                â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
     â”‚                      â”‚                                           â”‚
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
     â”‚           â”‚ 5. RRF Fusion       â”‚                               â”‚
     â”‚           â”‚    (merge results)  â”‚                               â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
     â”‚                      â”‚                                           â”‚
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
     â”‚           â”‚ 6. Cross-Encoder    â”‚                               â”‚
     â”‚           â”‚    Reranking        â”‚                               â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
     â”‚                      â”‚                                           â”‚
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
     â”‚           â”‚ 7. Build Prompt     â”‚                               â”‚
     â”‚           â”‚   (with guardrails) â”‚                               â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
     â”‚                      â”‚                                           â”‚
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
     â”‚           â”‚ 8. LLM Generate     â”‚                               â”‚
     â”‚           â”‚    Answer           â”‚                               â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
     â”‚                      â”‚                                           â”‚
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
     â”‚           â”‚ 9. Return Answer    â”‚                               â”‚
     â”‚           â”‚    + Sources        â”‚                               â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ƒï¸ Database Schema

```sql
-- Users (Multi-tenant)
CREATE TABLE users (
    id          VARCHAR(36) PRIMARY KEY,
    email       VARCHAR(320) UNIQUE NOT NULL,
    api_key     VARCHAR(128) UNIQUE NOT NULL,
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

-- Documents
CREATE TABLE documents (
    id           VARCHAR(36) PRIMARY KEY,
    user_id      VARCHAR(36) REFERENCES users(id) ON DELETE CASCADE,
    filename     VARCHAR(512) NOT NULL,
    content_type VARCHAR(128) NOT NULL,
    file_path    TEXT NOT NULL,
    size_bytes   INTEGER NOT NULL,
    file_sha256  VARCHAR(64),  -- For idempotency
    status       VARCHAR(32) DEFAULT 'created',
    error        TEXT,
    created_at   TIMESTAMPTZ DEFAULT NOW(),
    updated_at   TIMESTAMPTZ DEFAULT NOW()
);
CREATE UNIQUE INDEX ON documents(user_id, file_sha256);

-- Chunk Store (Deduplicated)
CREATE TABLE chunk_store (
    id          VARCHAR(36) PRIMARY KEY,
    user_id     VARCHAR(36) REFERENCES users(id) ON DELETE CASCADE,
    chunk_hash  VARCHAR(64) NOT NULL,  -- SHA256 of normalized text
    text        TEXT NOT NULL,
    tsv         TSVECTOR GENERATED ALWAYS AS (to_tsvector('simple', text)) STORED,
    created_at  TIMESTAMPTZ DEFAULT NOW()
);
CREATE UNIQUE INDEX ON chunk_store(user_id, chunk_hash);
CREATE INDEX ON chunk_store USING GIN(tsv);

-- Document â†’ Chunks Mapping
CREATE TABLE document_chunks (
    document_id VARCHAR(36) REFERENCES documents(id) ON DELETE CASCADE,
    ord         INTEGER,  -- Chunk order within document
    chunk_id    VARCHAR(36) REFERENCES chunk_store(id) ON DELETE CASCADE,
    PRIMARY KEY (document_id, ord)
);
```

---

## ğŸ”§ Design Decisions

| Decision | Why |
|----------|-----|
| **No text in Qdrant** | Reduces storage, single source of truth in Postgres |
| **GENERATED tsvector** | Automatic, consistent, no trigger needed |
| **Chunk dedup by hash** | Saves storage and embedding costs |
| **RRF over weighted fusion** | No score calibration needed |
| **Local Cross-Encoder** | No API costs, works offline |
| **Cached embeddings** | 7-day TTL, major cost reduction |
| **Celery for indexing** | Non-blocking, scalable, retryable |
